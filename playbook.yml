---
- name: Full Stack Monitoring Setup (Install Agent + Register to Server)
  hosts: all
  become: yes          # Bắt buộc có quyền root để cài agent
  gather_facts: yes    # Lấy thông tin máy đích

  vars:
    # --- CẤU HÌNH CHUNG ---
    zabbix_server_ip: "192.168.1.12"  # IP của Docker Zabbix Server

  tasks:
    # ============================================
    # PHẦN 1: CÀI ĐẶT AGENT (Chạy trên máy 192.168.1.13)
    # ============================================
    
    - name: Install Zabbix Agent (Debian/Ubuntu)
      apt:
        name: zabbix-agent
        state: present
        update_cache: yes

    - name: Configure Zabbix Agent - Server IP
      lineinfile:
        path: /etc/zabbix/zabbix_agentd.conf
        regexp: '^Server='
        line: "Server={{ zabbix_server_ip }}"
      notify: Restart Zabbix Agent

    - name: Configure Zabbix Agent - ServerActive IP
      lineinfile:
        path: /etc/zabbix/zabbix_agentd.conf
        regexp: '^ServerActive='
        line: "ServerActive={{ zabbix_server_ip }}"
      notify: Restart Zabbix Agent

    - name: Configure Zabbix Agent - Hostname
      lineinfile:
        path: /etc/zabbix/zabbix_agentd.conf
        regexp: '^Hostname='
        line: "Hostname={{ inventory_hostname }}"
      notify: Restart Zabbix Agent

    - name: Start Zabbix Agent Service
      service:
        name: zabbix-agent
        state: started
        enabled: yes

    # ============================================
    # PHẦN 2: ĐĂNG KÝ LÊN SERVER (Chạy tại Localhost)
    # ============================================
    
    - name: Register Host to Zabbix Server via API
      delegate_to: localhost   # Chạy task này tại máy Jenkins
      
      vars:
        # --- Cấu hình kết nối API Zabbix ---
        ansible_connection: httpapi
        ansible_network_os: community.zabbix.zabbix
        ansible_host: "{{ zabbix_server_ip }}"
        ansible_httpapi_port: 80
        ansible_user: Admin
        ansible_httpapi_pass: zabbix
        ansible_httpapi_zabbix_path: "/" 
        ansible_zabbix_url_path: "/"

      community.zabbix.zabbix_host:
        host_name: "{{ inventory_hostname }}"
        visible_name: "{{ inventory_hostname }} - Correct IP Fixed"
        host_groups:
          - Linux servers
        link_templates:
          - Linux by Zabbix agent
        status: enabled
        state: present
        interfaces:
          - type: 1
            main: 1
            useip: 1
            # --- ĐIỂM SỬA QUAN TRỌNG NHẤT ---
            # Dùng inventory_hostname để lấy chính xác IP 192.168.1.13
            ip: "{{ inventory_hostname }}"
            # -------------------------------
            dns: ""
            port: "10050"

  # ============================================
  # HANDLERS (Chỉ chạy khi file config thay đổi)
  # ============================================
  handlers:
    - name: Restart Zabbix Agent
      service:
        name: zabbix-agent
        state: restarted
